name: C/C++ CI and Docker Build

on:
  push:
    branches: [ "branchHTTPServer" ]
  pull_request:
    branches: [ "branchHTTPServer" ]
  workflow_dispatch:
    branches: [ "branchHTTPServer" ]

jobs:
  build:

    runs-on: ubuntu-latest

steps:
  - name: Checkout repository
    uses: actions/checkout@v4

  - name: Log in to the Container registry
    run: docker login -u ${{ vars.DOCKER_USERNAME }} -p ${{ secrets.DOCKERHUB_TOKEN }}

  - name: Build dockerfile
    run: docker build --platform=linux/amd64 -t markshukyhin/optimadevops:amd64 --push .

  - name: Run amd64 container
    run: docker run --rm markshukyhin/optimadevops:amd64

  - name: QEMU install
    uses: docker/setup-qemu-action@v3

  - name: Install Docker Buildx
    uses: docker/setup-buildx-action@v1

  - name: build ls
    run: docker buildx ls

  - name: Build dockerfile
    run: docker build --platform=linux/arm64 -t markshukyhin/optimadevops:arm64 --push .

  - name: list images
    run: docker image ls

  - name: create manifest
    run: docker manifest create markshukyhin/optimadevops --amend markshukyhin/optimadevops:amd64 --amend markshukyhin/optimadevops:arm64

  - name: Push manifest to docker hub
    run: docker manifest push markshukyhin/optimadevops

